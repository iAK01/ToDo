<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner - Smart Packing Lists</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .trip-setup {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .trip-setup h2 {
            color: #495057;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .weather-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .weather-section h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .weather-day {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .weather-day .temp-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            margin-top: 8px;
            font-weight: 600;
        }

        .temp-cold { background: #74b9ff; color: white; }
        .temp-mild { background: #00b894; color: white; }
        .temp-warm { background: #fdcb6e; color: #333; }
        .temp-hot { background: #e17055; color: white; }

        .progress-section {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12.5px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .trip-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .trip-summary h4 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .trip-summary p {
            margin-bottom: 8px;
            opacity: 0.95;
        }

        .trip-summary div {
            margin-top: 12px;
        }

        .category {
            background: #fff;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .category-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .category-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .category-content {
            padding: 25px;
            display: none;
        }

        .category-content.expanded {
            display: block;
        }

        .category.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.3s ease;
        }

        .item:hover {
            background: #f8f9fa;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item.completed {
            background: #d4edda;
            opacity: 0.8;
        }

        .item-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .item-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 500;
            color: #495057;
        }

        .item.completed .item-name {
            text-decoration: line-through;
            color: #6c757d;
        }

        .item-quantity {
            background: #e7f3ff;
            color: #0066cc;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .item-notes {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.9em;
            resize: vertical;
        }

        .add-item-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #dee2e6;
        }

        .add-item-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .floating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .notification.success { background: #28a745; }
        .notification.info { background: #17a2b8; }
        .notification.warning { background: #ffc107; color: #333; }
        .notification.error { background: #dc3545; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .weather-grid { grid-template-columns: 1fr; }
            .control-panel { bottom: 10px; right: 10px; }
            .floating-btn { width: 50px; height: 50px; font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß≥ Smart Trip Planner</h1>
            <p>Never forget anything important again - AI-powered packing lists</p>
        </div>

        <div class="main-content">
            <!-- Trip Setup Section -->
            <div class="trip-setup" id="tripSetup">
                <h2>üó∫Ô∏è Plan Your Trip</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="location">üìç Destination</label>
                        <input type="text" id="location" placeholder="e.g., Athens, Greece">
                    </div>
                    <div class="form-group">
                        <label for="nights">üåô Number of Nights</label>
                        <input type="number" id="nights" min="1" max="365" value="5">
                    </div>
                    <div class="form-group">
                        <label for="tripType">üéØ Trip Type</label>
                        <select id="tripType">
                            <option value="business">Business</option>
                            <option value="leisure">Leisure</option>
                            <option value="camping">Camping</option>
                            <option value="winter-sports">Winter Sports</option>
                            <option value="beach">Beach</option>
                            <option value="city-break">City Break</option>
                        </select>
                    </div>
                    <div class="form-row">
    <div class="form-group" style="grid-column: 1 / -1;">
        <label>üéØ Activities you might do on this trip (check all that apply):</label>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
            <label><input type="checkbox" id="activity-business" style="margin-right: 8px;">üíº Business meetings/conferences</label>
            <label><input type="checkbox" id="activity-sightseeing" style="margin-right: 8px;">üèõÔ∏è Sightseeing & museums</label>
            <label><input type="checkbox" id="activity-hiking" style="margin-right: 8px;">ü•æ Hiking & outdoor activities</label>
            <label><input type="checkbox" id="activity-beach" style="margin-right: 8px;">üèñÔ∏è Beach & water sports</label>
            <label><input type="checkbox" id="activity-workout" style="margin-right: 8px;">üí™ Gym & fitness</label>
            <label><input type="checkbox" id="activity-photography" style="margin-right: 8px;">üì∏ Photography</label>
        </div>
    </div>
</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">üìÖ Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="notes">üìù Special Notes</label>
                        <textarea id="notes" rows="3" placeholder="hiking, sightseeing, photography, gym workouts..."></textarea>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateTripList()">üöÄ Generate Smart List</button>
                    <button class="btn btn-secondary" onclick="loadSavedTrip()">üìÇ Load Saved Trip</button>
                    <button class="btn btn-danger" onclick="resetTrip()">üîÑ Reset Everything</button>
                </div>
            </div>

            <!-- Weather Section -->
            <div class="weather-section hidden" id="weatherSection">
                <h3>üå§Ô∏è Weather Forecast</h3>
                <div class="weather-grid" id="weatherGrid"></div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section hidden" id="progressSection">
                <h3>üìä Packing Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div id="progressStats">
                    <p><strong>0</strong> of <strong>0</strong> items packed</p>
                </div>
            </div>

            <!-- Checklist Section -->
            <div id="checklistContainer" class="hidden"></div>
        </div>
    </div>

    <!-- Floating Control Panel -->
    <div class="control-panel">
        <button class="floating-btn btn-success" onclick="exportList()" title="Export List">üì§</button>
        <button class="floating-btn btn-primary" onclick="saveTrip()" title="Save Trip">üíæ</button>
        <button class="floating-btn" style="background: #6f42c1;" onclick="scrollToTop()" title="Back to Top">‚¨ÜÔ∏è</button>
    </div>

    <script>
        // Global state management
        let currentTrip = {
            location: '',
            nights: 5,
            tripType: 'business',
            startDate: '',
            notes: '',
            items: {},
            completedItems: [],
            customItems: {},
            weather: null
        };

        // Storage key for persistence
        const STORAGE_KEY = 'smart-trip-planner';

        // Base essential items (always included)
        const essentialItems = {
            clothes: {
                icon: 'üëî',
                items: {
                    'Underwear': { 
                        multiplier: 0.8, // 4 for 5 days
                        essential: true,
                        min: 3,
                        description: 'Plus 1 spare'
                    },
                    'Socks': { 
                        multiplier: 0.8, 
                        essential: true,
                        min: 3,
                        description: 'Mix of thick/thin as needed'
                    },
                    'Sleep bottoms': { multiplier: 0.4, essential: true, min: 2 },
                    'Sleep tops': { multiplier: 0.4, essential: true, min: 2 },
                    'Basic trousers/jeans': { multiplier: 0.4, essential: true, min: 2 }
                }
            },
            toiletries: {
                icon: 'üß¥',
                items: {
                    'Toothbrush & toothpaste': { multiplier: 0, essential: true },
                    'Shower gel/soap': { multiplier: 0, essential: true },
                    'Shampoo': { multiplier: 0, essential: true },
                    'Deodorant': { multiplier: 0, essential: true },
                    'Prescription medication': { multiplier: 0, essential: true }
                }
            },
            electronics: {
                icon: 'üíª',
                items: {
                    'Phone charger': { multiplier: 0, essential: true },
                    'Power bank': { multiplier: 0, essential: true },
                    'Universal adapter': { multiplier: 0, essential: true }
                }
            },
            documents: {
                icon: 'üìÑ',
                items: {
                    'Passport/ID': { multiplier: 0, essential: true },
                    'Travel insurance': { multiplier: 0, essential: true },
                    'Payment cards': { multiplier: 0, essential: true },
                    'Flight/transport tickets': { multiplier: 0, essential: true }
                }
            }
        };

        // Conditional items based on weather, activities, and trip type
        const conditionalItems = {
            weather: {
                cold: {
                    trigger: (weather) => weather.some(day => day.temp < 10),
                    items: {
                        'Warm coat/jacket': { multiplier: 0, essential: true },
                        'Thermal underwear': { multiplier: 0.4, essential: false },
                        'Warm hat': { multiplier: 0, essential: true },
                        'Gloves': { multiplier: 0, essential: true },
                        'Warm socks': { multiplier: 0.6, essential: false }
                    }
                },
                hot: {
                    trigger: (weather) => weather.some(day => day.temp > 25),
                    items: {
                        'Light tops': { 
                            multiplier: 0.8, 
                            essential: true,
                            replaces: ['Heavy shirts', 'Sweaters'],
                            description: 'Lightweight breathable shirts'
                        },
                        'Shorts': { multiplier: 0.4, essential: true },
                        'Sun hat': { multiplier: 0, essential: true },
                        'Sunglasses': { multiplier: 0, essential: true },
                        'Sunscreen': { multiplier: 0, essential: true },
                        'Light sandals': { multiplier: 0, essential: false }
                    }
                },
                rainy: {
                    trigger: (weather) => weather.some(day => day.condition.toLowerCase().includes('rain')),
                    items: {
                        'Waterproof jacket': { multiplier: 0, essential: true },
                        'Compact umbrella': { multiplier: 0, essential: true },
                        'Waterproof shoes': { multiplier: 0, essential: false }
                    }
                }
            },
            activities: {
                hiking: {
                    trigger: (notes, tripType) => 
                        notes.toLowerCase().includes('hik') || 
                        notes.toLowerCase().includes('trek') || 
                        notes.toLowerCase().includes('trail') ||
                        tripType === 'camping',
                    items: {
                        'Hiking boots': { multiplier: 0, essential: true },
                        'Hiking backpack': { multiplier: 0, essential: true },
                        'Quick-dry shirts': { multiplier: 0.6, essential: true },
                        'Hiking pants': { multiplier: 0.4, essential: true },
                        'First aid kit': { multiplier: 0, essential: true },
                        'Water bottle': { multiplier: 0, essential: true },
                        'Hiking socks': { multiplier: 0.8, essential: true }
                    }
                },
                sightseeing: {
                    trigger: (notes, tripType) => 
                        notes.toLowerCase().includes('sight') || 
                        notes.toLowerCase().includes('museum') || 
                        notes.toLowerCase().includes('tour') ||
                        tripType === 'leisure' || tripType === 'city-break',
                    items: {
                        'Comfortable walking shoes': { multiplier: 0, essential: true },
                        'Small daypack': { multiplier: 0, essential: true },
                        'Camera': { multiplier: 0, essential: false },
                        'Portable phone charger': { multiplier: 0, essential: true },
                        'Comfortable casual clothes': { multiplier: 0.6, essential: true }
                    }
                },
                business: {
                    trigger: (notes, tripType) => 
                        tripType === 'business' || 
                        notes.toLowerCase().includes('meeting') || 
                        notes.toLowerCase().includes('conference'),
                    items: {
                        'Business shirts': { multiplier: 0.4, essential: true, min: 2 },
                        'Formal trousers': { multiplier: 0.3, essential: true, min: 2 },
                        'Formal shoes': { multiplier: 0, essential: true },
                        'Blazer/jacket': { multiplier: 0, essential: true },
                        'Ties': { multiplier: 0.4, essential: false, min: 2 },
                        'Business cards': { multiplier: 0, essential: true },
                        'Laptop & charger': { multiplier: 0, essential: true },
                        'Notebook & pens': { multiplier: 0, essential: true }
                    }
                },
                beach: {
                    trigger: (notes, tripType) => 
                        tripType === 'beach' || 
                        notes.toLowerCase().includes('beach') || 
                        notes.toLowerCase().includes('swim'),
                    items: {
                        'Swimwear': { multiplier: 0.4, essential: true, min: 2 },
                        'Beach towel': { multiplier: 0, essential: true },
                        'Flip flops': { multiplier: 0, essential: true },
                        'Waterproof phone case': { multiplier: 0, essential: false },
                        'Beach bag': { multiplier: 0, essential: false }
                    }
                },
                photography: {
                    trigger: (notes) => 
                        notes.toLowerCase().includes('photo') || 
                        notes.toLowerCase().includes('camera') ||
                        notes.toLowerCase().includes('instagram'),
                    items: {
                        'Camera equipment': { multiplier: 0, essential: true },
                        'Extra memory cards': { multiplier: 0, essential: true },
                        'Camera batteries': { multiplier: 0, essential: true },
                        'Tripod': { multiplier: 0, essential: false },
                        'Lens cleaning kit': { multiplier: 0, essential: false }
                    }
                },
                workout: {
                    trigger: (notes) => 
                        notes.toLowerCase().includes('gym') || 
                        notes.toLowerCase().includes('workout') ||
                        notes.toLowerCase().includes('exercise') ||
                        notes.toLowerCase().includes('run'),
                    items: {
                        'Workout clothes': { multiplier: 0.4, essential: true },
                        'Sports shoes': { multiplier: 0, essential: true },
                        'Sports socks': { multiplier: 0.6, essential: true },
                        'Gym towel': { multiplier: 0, essential: false }
                    }
                }
            },
            duration: {
                short: {
                    trigger: (nights) => nights <= 3,
                    items: {
                        'Laundry detergent pods': { multiplier: 0, essential: false }
                    }
                },
                long: {
                    trigger: (nights) => nights >= 7,
                    items: {
                        'Laundry detergent': { multiplier: 0, essential: true },
                        'Extra toiletries': { multiplier: 0, essential: true },
                        'Backup charger': { multiplier: 0, essential: false }
                    }
                }
            }
        };

        // Temperature-based clothing logic
        const temperatureClothing = {
            cold: {
                trigger: (avgTemp) => avgTemp < 10,
                replaces: ['Light tops', 'Shorts', 'Light shirts'],
                items: {
                    'Warm sweaters': { multiplier: 0.4, essential: true },
                    'Long pants': { multiplier: 0.6, essential: true },
                    'Warm shirts': { multiplier: 0.6, essential: true }
                }
            },
            mild: {
                trigger: (avgTemp) => avgTemp >= 10 && avgTemp <= 20,
                items: {
                    'Light sweaters': { multiplier: 0.3, essential: false },
                    'Medium-weight shirts': { multiplier: 0.6, essential: true },
                    'Jeans/casual pants': { multiplier: 0.4, essential: true }
                }
            },
            warm: {
                trigger: (avgTemp) => avgTemp > 20,
                replaces: ['Heavy sweaters', 'Thermal wear', 'Heavy coats'],
                items: {
                    'Light shirts/tops': { multiplier: 0.8, essential: true },
                    'Light pants/chinos': { multiplier: 0.4, essential: true }
                }
            }
        };

// Real weather API integration
async function fetchWeatherData() {
    const API_KEY = '90c4c9014ba54aecadd160109231806';
    const days = Math.min(currentTrip.nights, 7); // WeatherAPI free tier supports up to 10 days
    
    try {
        const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${encodeURIComponent(currentTrip.location)}&days=${days}&aqi=no&alerts=no`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message);
        }
        
        currentTrip.weather = [];
        
        // Process forecast data
        data.forecast.forecastday.forEach(day => {
            const date = new Date(day.date);
            const condition = day.day.condition.text;
            const temp = Math.round(day.day.avgtemp_c);
            const icon = getWeatherIcon(condition, temp);
            
            currentTrip.weather.push({
                date: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                condition: condition,
                temp: temp,
                icon: icon,
                humidity: day.day.avghumidity,
                chanceOfRain: day.day.daily_chance_of_rain,
                maxTemp: Math.round(day.day.maxtemp_c),
                minTemp: Math.round(day.day.mintemp_c)
            });
        });
        
        renderWeather();
        
    } catch (error) {
        console.error('Weather API failed:', error);
        showNotification(`Weather fetch failed: ${error.message}. Using default settings.`, 'warning');
        
        // Fallback to basic weather simulation
        createFallbackWeather();
        renderWeather();
    }
}

// Fallback weather if API fails
function createFallbackWeather() {
    currentTrip.weather = [];
    const startDate = new Date(currentTrip.startDate);
    
    for (let i = 0; i < Math.min(currentTrip.nights, 7); i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        
        currentTrip.weather.push({
            date: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
            condition: 'Partly Cloudy',
            temp: 20,
            icon: 'üå§Ô∏è',
            humidity: 50,
            chanceOfRain: 20,
            maxTemp: 25,
            minTemp: 15
        });
    }
}    

        function getWeatherIcon(condition, temp) {
            const conditionLower = condition.toLowerCase();
            
            if (conditionLower.includes('rain') || conditionLower.includes('storm')) {
                return 'üåßÔ∏è';
            } else if (conditionLower.includes('snow')) {
                return '‚ùÑÔ∏è';
            } else if (conditionLower.includes('cloud')) {
                return '‚òÅÔ∏è';
            } else if (conditionLower.includes('sunny') || conditionLower.includes('clear') || conditionLower.includes('hot')) {
                return '‚òÄÔ∏è';
            } else if (temp > 25) {
                return 'üå§Ô∏è';
            } else if (temp < 5) {
                return 'ü•∂';
            } else {
                return 'üå§Ô∏è';
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            setDefaultDate();
        });

        function setDefaultDate() {
            const today = new Date();
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
        }

function generateTripList() {
            // Get form values
            currentTrip.location = document.getElementById('location').value.trim();
            currentTrip.nights = parseInt(document.getElementById('nights').value);
            currentTrip.tripType = document.getElementById('tripType').value;
            currentTrip.startDate = document.getElementById('startDate').value;
            currentTrip.notes = document.getElementById('notes').value.trim();

            if (!currentTrip.location || !currentTrip.nights) {
                showNotification('Please enter destination and number of nights', 'warning');
                return;
            }

            // Fetch weather first (affects clothing choices)
            fetchWeatherData();
            
            // Generate items based on trip parameters (now weather-aware)
            setTimeout(() => {
                generateItems();
                
                // Show sections
                document.getElementById('weatherSection').classList.remove('hidden');
                document.getElementById('progressSection').classList.remove('hidden');
                document.getElementById('checklistContainer').classList.remove('hidden');
                
                // Render checklist
                renderChecklist();
                updateProgress();
                
                // Save to storage
                saveToStorage();
                
                showNotification('Smart packing list generated! üéØ', 'success');
            }, 100);
        }

        function generateItems() {
            currentTrip.items = {};
            
            // Step 1: Add essential base items
            for (const [categoryKey, category] of Object.entries(essentialItems)) {
                currentTrip.items[categoryKey] = {};
                
                for (const [itemName, itemData] of Object.entries(category.items)) {
                    let quantity = calculateQuantity(itemData, currentTrip.nights);
                    
                    currentTrip.items[categoryKey][itemName] = {
                        quantity: quantity,
                        essential: itemData.essential,
                        completed: false,
                        notes: itemData.description || ''
                    };
                }
            }
            
            // Step 2: Calculate average temperature for clothing decisions
            const avgTemp = currentTrip.weather ? 
                currentTrip.weather.reduce((sum, day) => sum + day.temp, 0) / currentTrip.weather.length : 20;
            
            // Step 3: Add temperature-appropriate clothing
            addTemperatureClothing(avgTemp);
            
            // Step 4: Add conditional items based on triggers
            addConditionalItems();
            
            // Step 5: Remove replaced items
            removeReplacedItems();
        }

        function calculateQuantity(itemData, nights) {
            if (itemData.multiplier === 0) return 1;
            
            let quantity = Math.ceil(nights * itemData.multiplier);
            
            // Apply minimum if specified
            if (itemData.min && quantity < itemData.min) {
                quantity = itemData.min;
            }
            
            // Cap at reasonable maximums
            if (quantity > nights + 2) {
                quantity = nights + 2;
            }
            
            return Math.max(1, quantity);
        }

        function addTemperatureClothing(avgTemp) {
            for (const [tempRange, config] of Object.entries(temperatureClothing)) {
                if (config.trigger(avgTemp)) {
                    if (!currentTrip.items.clothes) {
                        currentTrip.items.clothes = {};
                    }
                    
                    for (const [itemName, itemData] of Object.entries(config.items)) {
                        const quantity = calculateQuantity(itemData, currentTrip.nights);
                        
                        currentTrip.items.clothes[itemName] = {
                            quantity: quantity,
                            essential: itemData.essential,
                            completed: false,
                            notes: `Added for ${tempRange} weather (${Math.round(avgTemp)}¬∞C avg)`
                        };
                    }
                }
            }
        }

        function addConditionalItems() {
            // Weather-based items
            if (currentTrip.weather) {
                for (const [condition, config] of Object.entries(conditionalItems.weather)) {
                    if (config.trigger(currentTrip.weather)) {
                        addItemsToCategory('weather_gear', config.items, `${condition} weather`);
                    }
                }
            }
            
            // Activity-based items
            for (const [activity, config] of Object.entries(conditionalItems.activities)) {
                if (config.trigger(currentTrip.notes, currentTrip.tripType)) {
                    const categoryName = activity === 'business' ? 'business_items' : 
                                       activity === 'beach' ? 'beach_gear' :
                                       activity === 'hiking' ? 'hiking_gear' :
                                       activity === 'photography' ? 'photography_gear' :
                                       activity === 'workout' ? 'fitness_gear' :
                                       'activity_items';
                    
                    addItemsToCategory(categoryName, config.items, `${activity} activities`);
                }
            }
            
            // Duration-based items
            for (const [duration, config] of Object.entries(conditionalItems.duration)) {
                if (config.trigger(currentTrip.nights)) {
                    addItemsToCategory('travel_essentials', config.items, `${duration} trip`);
                }
            }
        }

        function addItemsToCategory(categoryKey, items, reason) {
            if (!currentTrip.items[categoryKey]) {
                currentTrip.items[categoryKey] = {};
            }
            
            for (const [itemName, itemData] of Object.entries(items)) {
                // Skip if item would be replaced
                if (itemData.replaces && shouldSkipDueToReplacement(itemData.replaces)) {
                    continue;
                }
                
                const quantity = calculateQuantity(itemData, currentTrip.nights);
                
                currentTrip.items[categoryKey][itemName] = {
                    quantity: quantity,
                    essential: itemData.essential,
                    completed: false,
                    notes: itemData.description ? `${itemData.description} (${reason})` : `Added for ${reason}`
                };
            }
        }

        function shouldSkipDueToReplacement(replacedItems) {
            // Check if any of the items this would replace are already included
            for (const categoryItems of Object.values(currentTrip.items)) {
                for (const itemName of Object.keys(categoryItems)) {
                    if (replacedItems.some(replaced => 
                        itemName.toLowerCase().includes(replaced.toLowerCase()) ||
                        replaced.toLowerCase().includes(itemName.toLowerCase())
                    )) {
                        return false; // Don't skip, we want to replace
                    }
                }
            }
            return false;
        }

        function removeReplacedItems() {
            const itemsToRemove = [];
            
            // Find items that should be replaced
            for (const [categoryKey, categoryItems] of Object.entries(currentTrip.items)) {
                for (const [itemName, itemData] of Object.entries(categoryItems)) {
                    // Check if this item is marked for replacement by conditional items
                    for (const conditionGroup of Object.values(conditionalItems)) {
                        for (const condition of Object.values(conditionGroup)) {
                            if (condition.items) {
                                for (const [newItemName, newItemData] of Object.entries(condition.items)) {
                                    if (newItemData.replaces && newItemData.replaces.some(replaced => 
                                        itemName.toLowerCase().includes(replaced.toLowerCase())
                                    )) {
                                        // Check if the replacing item was actually added
                                        const replacingItemExists = Object.values(currentTrip.items)
                                            .some(catItems => Object.keys(catItems)
                                                .some(name => name === newItemName));
                                        
                                        if (replacingItemExists) {
                                            itemsToRemove.push({ category: categoryKey, item: itemName });
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Remove the items
            itemsToRemove.forEach(({ category, item }) => {
                delete currentTrip.items[category][item];
            });
            
            // Clean up empty categories
            for (const [categoryKey, categoryItems] of Object.entries(currentTrip.items)) {
                if (Object.keys(categoryItems).length === 0) {
                    delete currentTrip.items[categoryKey];
                }
            }
        }

  function renderWeather() {
    const weatherGrid = document.getElementById('weatherGrid');
    weatherGrid.innerHTML = '';
    
    if (currentTrip.weather) {
        currentTrip.weather.forEach(day => {
            const tempClass = day.temp < 10 ? 'temp-cold' : 
                             day.temp < 20 ? 'temp-mild' : 
                             day.temp < 25 ? 'temp-warm' : 'temp-hot';
            
            const dayElement = document.createElement('div');
            dayElement.className = 'weather-day';
            dayElement.innerHTML = `
                <div style="font-size: 2.5em; margin-bottom: 10px;">${day.icon}</div>
                <div style="font-weight: 600; margin-bottom: 5px;">${day.date}</div>
                <div style="margin-bottom: 8px;">${day.condition}</div>
                <div class="temp-indicator ${tempClass}">${day.temp}¬∞C</div>
                <div style="font-size: 0.85em; margin-top: 8px; opacity: 0.9;">
                    <div>High: ${day.maxTemp || day.temp}¬∞C | Low: ${day.minTemp || day.temp}¬∞C</div>
                    <div style="margin-top: 4px;">
                        üíß ${day.humidity || 50}% | ‚òî ${day.chanceOfRain || 0}%
                    </div>
                </div>
            `;
            weatherGrid.appendChild(dayElement);
        });
        
        // Add weather insights
        const insights = generateWeatherInsights();
        if (insights) {
            const insightsElement = document.createElement('div');
            insightsElement.style.cssText = 'grid-column: 1 / -1; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 10px;';
            insightsElement.innerHTML = `<strong>üîç Weather Insights:</strong> ${insights}`;
            weatherGrid.appendChild(insightsElement);
        }
    }
}

        function generateWeatherInsights() {
            if (!currentTrip.weather) return '';
            
            const temps = currentTrip.weather.map(d => d.temp);
            const conditions = currentTrip.weather.map(d => d.condition);
            
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            const avgTemp = Math.round(temps.reduce((a, b) => a + b, 0) / temps.length);
            const rainDays = conditions.filter(c => c.toLowerCase().includes('rain')).length;
            
            const insights = [];
            
            if (maxTemp - minTemp > 10) {
                insights.push(`Temperature varies widely (${minTemp}¬∞C to ${maxTemp}¬∞C) - pack layers`);
            }
            
            if (rainDays > 0) {
                insights.push(`${rainDays} day${rainDays > 1 ? 's' : ''} of rain expected - waterproof gear included`);
            }
            
            if (avgTemp < 10) {
                insights.push('Cold weather expected - warm clothing prioritized');
            } else if (avgTemp > 25) {
                insights.push('Warm weather expected - light, breathable items prioritized');
            }
            
            return insights.join(' ‚Ä¢ ');
        }

        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            container.innerHTML = '';
            
            const categoryNames = {
                clothes: 'üëî Clothes',
                toiletries: 'üß¥ Toiletries', 
                electronics: 'üíª Electronics',
                documents: 'üìÑ Documents',
                weather_gear: '‚òî Weather Gear',
                business_items: 'üíº Business Items',
                hiking_gear: 'ü•æ Hiking Gear',
                beach_gear: 'üèñÔ∏è Beach Gear',
                photography_gear: 'üì∏ Photography',
                fitness_gear: 'üí™ Fitness',
                activity_items: 'üéØ Activity Items',
                travel_essentials: '‚úàÔ∏è Travel Essentials'
            };
            
            // Show summary of what was included/excluded
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'trip-summary';
            summaryDiv.innerHTML = generateTripSummary();
            container.appendChild(summaryDiv);
            
            for (const [categoryKey, items] of Object.entries(currentTrip.items)) {
                if (Object.keys(items).length === 0) continue;
                
                const category = createCategoryElement(
                    categoryKey,
                    categoryNames[categoryKey] || categoryKey.replace('_', ' '),
                    getCategoryIcon(categoryKey),
                    items
                );
                container.appendChild(category);
            }
        }

        function generateTripSummary() {
            const avgTemp = currentTrip.weather ? 
                Math.round(currentTrip.weather.reduce((sum, day) => sum + day.temp, 0) / currentTrip.weather.length) : 'Unknown';
            
            const conditions = [];
            
            // Weather conditions
            if (currentTrip.weather) {
                const hasRain = currentTrip.weather.some(day => day.condition.toLowerCase().includes('rain'));
                const hasCold = currentTrip.weather.some(day => day.temp < 10);
                const hasHot = currentTrip.weather.some(day => day.temp > 25);
                
                if (hasRain) conditions.push('üåßÔ∏è Rain gear included');
                if (hasCold) conditions.push('üß• Cold weather gear included');
                if (hasHot) conditions.push('‚òÄÔ∏è Hot weather items included');
            }
            
            // Activity conditions
            const detectedActivities = [];
            for (const [activity, config] of Object.entries(conditionalItems.activities)) {
                if (config.trigger(currentTrip.notes, currentTrip.tripType)) {
                    detectedActivities.push(activity);
                }
            }
            
            if (detectedActivities.length > 0) {
                conditions.push(`üéØ Added items for: ${detectedActivities.join(', ')}`);
            }
            
            return `
                <h4>üìã Smart Packing Summary</h4>
                <p><strong>Trip:</strong> ${currentTrip.location} ‚Ä¢ ${currentTrip.nights} nights ‚Ä¢ ${currentTrip.tripType}</p>
                <p><strong>Average Temperature:</strong> ${avgTemp}¬∞C</p>
                ${conditions.length > 0 ? `<div style="margin-top: 10px;">${conditions.map(c => `<div>${c}</div>`).join('')}</div>` : ''}
                <p style="margin-top: 10px; font-size: 0.9em; color: rgba(255,255,255,0.8);">
                    ‚ú® This list was automatically customized based on your destination, weather, and activities!
                </p>
            `;
        }

        function getCategoryIcon(categoryKey) {
            const icons = {
                clothes: 'üëî',
                toiletries: 'üß¥',
                electronics: 'üíª',
                documents: 'üìÑ',
                weather_gear: '‚òî',
                business_items: 'üíº',
                hiking_gear: 'ü•æ',
                beach_gear: 'üèñÔ∏è',
                photography_gear: 'üì∏',
                fitness_gear: 'üí™',
                activity_items: 'üéØ',
                travel_essentials: '‚úàÔ∏è'
            };
            return icons[categoryKey] || 'üì¶';
        }
function createCategoryElement(categoryKey, categoryName, icon, items) {
            const totalItems = Object.keys(items).length;
            const completedItems = Object.values(items).filter(item => item.completed).length;
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            categoryDiv.innerHTML = `
                <div class="category-header" onclick="toggleCategory('${categoryKey}')">
                    <div class="category-title">
                        <span>${icon}</span>
                        <span>${categoryName}</span>
                    </div>
                    <div class="category-progress">
                        <div class="category-badge">${completedItems}/${totalItems}</div>
                        <div class="category-badge">${percentage}%</div>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                </div>
                <div class="category-content" id="category-${categoryKey}">
                    ${Object.entries(items).map(([itemName, itemData]) => 
                        createItemElement(categoryKey, itemName, itemData)
                    ).join('')}
                    <div class="add-item-section">
                        <div class="add-item-form">
                            <input type="text" placeholder="Add custom item..." id="new-item-${categoryKey}">
                            <input type="number" placeholder="Qty" min="1" value="1" id="new-qty-${categoryKey}">
                            <button class="btn btn-primary" onclick="addCustomItem('${categoryKey}')">Add</button>
                        </div>
                    </div>
                </div>
            `;
            
            return categoryDiv;
        }

        function createItemElement(categoryKey, itemName, itemData) {
            const itemId = `${categoryKey}-${itemName.replace(/[^a-zA-Z0-9]/g, '')}`;
            return `
                <div class="item ${itemData.completed ? 'completed' : ''}" id="item-${itemId}">
                    <input type="checkbox" class="item-checkbox" 
                           ${itemData.completed ? 'checked' : ''} 
                           onchange="toggleItem('${categoryKey}', '${itemName}')">
                    <div class="item-content">
                        <div class="item-name">
                            ${itemName}
                            ${itemData.essential ? '<span style="color: #dc3545;">*</span>' : ''}
                        </div>
                        ${itemData.quantity > 1 ? `<div class="item-quantity">√ó${itemData.quantity}</div>` : ''}
                    </div>
                    <div style="width: 100%;">
                        <textarea class="item-notes" placeholder="Add notes..." 
                                  onchange="updateItemNotes('${categoryKey}', '${itemName}', this.value)">${itemData.notes || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function toggleCategory(categoryKey) {
            const content = document.getElementById(`category-${categoryKey}`);
            const category = content.parentElement;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                category.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                category.classList.add('expanded');
            }
        }

        function toggleItem(categoryKey, itemName) {
            currentTrip.items[categoryKey][itemName].completed = !currentTrip.items[categoryKey][itemName].completed;
            
            const itemId = `${categoryKey}-${itemName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const itemElement = document.getElementById(`item-${itemId}`);
            
            if (currentTrip.items[categoryKey][itemName].completed) {
                itemElement.classList.add('completed');
                showNotification(`‚úÖ ${itemName} packed!`, 'success');
            } else {
                itemElement.classList.remove('completed');
                showNotification(`üì¶ ${itemName} unpacked`, 'info');
            }
            
            updateProgress();
            saveToStorage();
            updateCategoryProgress(categoryKey);
        }

        function updateItemNotes(categoryKey, itemName, notes) {
            currentTrip.items[categoryKey][itemName].notes = notes;
            saveToStorage();
        }

        function addCustomItem(categoryKey) {
            const nameInput = document.getElementById(`new-item-${categoryKey}`);
            const qtyInput = document.getElementById(`new-qty-${categoryKey}`);
            
            const itemName = nameInput.value.trim();
            const quantity = parseInt(qtyInput.value) || 1;
            
            if (!itemName) {
                showNotification('Please enter an item name', 'warning');
                return;
            }
            
            if (currentTrip.items[categoryKey][itemName]) {
                showNotification('Item already exists in this category', 'warning');
                return;
            }
            
            currentTrip.items[categoryKey][itemName] = {
                quantity: quantity,
                essential: false,
                completed: false,
                notes: '',
                custom: true
            };
            
            // Clear inputs
            nameInput.value = '';
            qtyInput.value = '1';
            
            // Re-render the category
            renderChecklist();
            updateProgress();
            saveToStorage();
            
            showNotification(`Added "${itemName}" to ${categoryKey}`, 'success');
        }

        function updateProgress() {
            let totalItems = 0;
            let completedItems = 0;
            
            for (const [categoryKey, items] of Object.entries(currentTrip.items)) {
                for (const [itemName, itemData] of Object.entries(items)) {
                    totalItems++;
                    if (itemData.completed) {
                        completedItems++;
                    }
                }
            }
            
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            const progressFill = document.getElementById('progressFill');
            const progressStats = document.getElementById('progressStats');
            
            progressFill.style.width = `${percentage}%`;
            progressFill.textContent = `${percentage}%`;
            
            progressStats.innerHTML = `
                <p><strong>${completedItems}</strong> of <strong>${totalItems}</strong> items packed</p>
                ${percentage === 100 ? '<p style="color: #28a745; font-weight: 600;">üéâ All packed! Ready to go!</p>' : ''}
            `;
        }

        function updateCategoryProgress(categoryKey) {
            const items = currentTrip.items[categoryKey];
            const totalItems = Object.keys(items).length;
            const completedItems = Object.values(items).filter(item => item.completed).length;
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            // Update category header badges
            const categoryElement = document.querySelector(`[onclick="toggleCategory('${categoryKey}')"]`);
            if (categoryElement) {
                const badges = categoryElement.querySelectorAll('.category-badge');
                if (badges.length >= 2) {
                    badges[0].textContent = `${completedItems}/${totalItems}`;
                    badges[1].textContent = `${percentage}%`;
                }
            }
        }

        function saveTrip() {
            const tripName = prompt('Enter a name for this trip:', `${currentTrip.location} - ${currentTrip.tripType}`);
            if (!tripName) return;
            
            const savedTrips = JSON.parse(localStorage.getItem('saved-trips') || '{}');
            savedTrips[tripName] = { ...currentTrip };
            localStorage.setItem('saved-trips', JSON.stringify(savedTrips));
            
            showNotification(`Trip "${tripName}" saved!`, 'success');
        }

        function loadSavedTrip() {
            const savedTrips = JSON.parse(localStorage.getItem('saved-trips') || '{}');
            const tripNames = Object.keys(savedTrips);
            
            if (tripNames.length === 0) {
                showNotification('No saved trips found', 'info');
                return;
            }
            
            const tripName = prompt(`Choose a trip to load:\n${tripNames.map((name, i) => `${i + 1}. ${name}`).join('\n')}\n\nEnter trip name:`);
            
            if (tripName && savedTrips[tripName]) {
                currentTrip = { ...savedTrips[tripName] };
                
                // Update form fields
                document.getElementById('location').value = currentTrip.location;
                document.getElementById('nights').value = currentTrip.nights;
                document.getElementById('tripType').value = currentTrip.tripType;
                document.getElementById('startDate').value = currentTrip.startDate;
                document.getElementById('notes').value = currentTrip.notes;
                
                // Show sections
                document.getElementById('weatherSection').classList.remove('hidden');
                document.getElementById('progressSection').classList.remove('hidden');
                document.getElementById('checklistContainer').classList.remove('hidden');
                
                // Render everything
                renderWeather();
                renderChecklist();
                updateProgress();
                
                saveToStorage();
                showNotification(`Loaded trip "${tripName}"`, 'success');
            } else if (tripName) {
                showNotification('Trip not found', 'error');
            }
        }

        function exportList() {
            let exportText = `üß≥ PACKING LIST - ${currentTrip.location}\n`;
            exportText += `üìÖ ${currentTrip.startDate} | ${currentTrip.nights} nights | ${currentTrip.tripType}\n\n`;
            
            if (currentTrip.notes) {
                exportText += `üìù Notes: ${currentTrip.notes}\n\n`;
            }
            
            // Weather section
            if (currentTrip.weather) {
                exportText += `üå§Ô∏è WEATHER FORECAST:\n`;
                currentTrip.weather.forEach(day => {
                    exportText += `‚Ä¢ ${day.date}: ${day.condition}, ${day.temp}¬∞C\n`;
                });
                exportText += `\n`;
            }
            
            // Progress
            let totalItems = 0;
            let completedItems = 0;
            for (const items of Object.values(currentTrip.items)) {
                totalItems += Object.keys(items).length;
                completedItems += Object.values(items).filter(item => item.completed).length;
            }
            
            exportText += `üìä PROGRESS: ${completedItems}/${totalItems} items (${Math.round((completedItems/totalItems)*100)}%)\n\n`;
            
            // Categories
            const categoryNames = {
                clothes: 'üëî CLOTHES',
                toiletries: 'üß¥ TOILETRIES',
                electronics: 'üíª ELECTRONICS',
                documents: 'üìÑ DOCUMENTS',
                weather_gear: '‚òî WEATHER GEAR',
                business_items: 'üíº BUSINESS ITEMS',
                hiking_gear: 'ü•æ HIKING GEAR',
                beach_gear: 'üèñÔ∏è BEACH GEAR',
                photography_gear: 'üì∏ PHOTOGRAPHY',
                fitness_gear: 'üí™ FITNESS',
                activity_items: 'üéØ ACTIVITY ITEMS',
                travel_essentials: '‚úàÔ∏è TRAVEL ESSENTIALS'
            };
            
            for (const [categoryKey, items] of Object.entries(currentTrip.items)) {
                if (Object.keys(items).length === 0) continue;
                
                exportText += `${categoryNames[categoryKey] || categoryKey.toUpperCase()}:\n`;
                
                for (const [itemName, itemData] of Object.entries(items)) {
                    const checkbox = itemData.completed ? '‚òë' : '‚òê';
                    const quantity = itemData.quantity > 1 ? ` (√ó${itemData.quantity})` : '';
                    const essential = itemData.essential ? ' *' : '';
                    const notes = itemData.notes ? ` - ${itemData.notes}` : '';
                    
                    exportText += `${checkbox} ${itemName}${quantity}${essential}${notes}\n`;
                }
                exportText += `\n`;
            }
            
            exportText += `\n* = Essential items\n`;
            exportText += `Generated by Smart Trip Planner - ${new Date().toLocaleString()}`;
            
            // Create download
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `packing-list-${currentTrip.location.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Packing list exported!', 'success');
        }

        function resetTrip() {
            if (confirm('Are you sure you want to reset everything? This will clear your current trip and all progress.')) {
                currentTrip = {
                    location: '',
                    nights: 5,
                    tripType: 'business',
                    startDate: '',
                    notes: '',
                    items: {},
                    completedItems: [],
                    customItems: {},
                    weather: null
                };
                
                // Clear form
                document.getElementById('location').value = '';
                document.getElementById('nights').value = '5';
                document.getElementById('tripType').value = 'business';
                document.getElementById('startDate').value = '';
                document.getElementById('notes').value = '';
                
                // Hide sections
                document.getElementById('weatherSection').classList.add('hidden');
                document.getElementById('progressSection').classList.add('hidden');
                document.getElementById('checklistContainer').classList.add('hidden');
                
                // Clear storage
                localStorage.removeItem(STORAGE_KEY);
                
                showNotification('Trip reset successfully!', 'info');
                setDefaultDate();
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentTrip));
            } catch (error) {
                console.error('Failed to save to storage:', error);
                showNotification('Failed to save progress', 'error');
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const savedTrip = JSON.parse(saved);
                    
                    // Merge with current trip to handle any new structure
                    currentTrip = { ...currentTrip, ...savedTrip };
                    
                    // Update form if we have saved data
                    if (currentTrip.location) {
                        document.getElementById('location').value = currentTrip.location;
                        document.getElementById('nights').value = currentTrip.nights;
                        document.getElementById('tripType').value = currentTrip.tripType;
                        document.getElementById('startDate').value = currentTrip.startDate;
                        document.getElementById('notes').value = currentTrip.notes;
                        
                        // Show sections if we have items
                        if (Object.keys(currentTrip.items).length > 0) {
                            document.getElementById('weatherSection').classList.remove('hidden');
                            document.getElementById('progressSection').classList.remove('hidden');
                            document.getElementById('checklistContainer').classList.remove('hidden');
                            
                            renderWeather();
                            renderChecklist();
                            updateProgress();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load from storage:', error);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Auto-save functionality
        setInterval(() => {
            if (Object.keys(currentTrip.items).length > 0) {
                saveToStorage();
            }
        }, 30000); // Auto-save every 30 seconds

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            saveToStorage();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveTrip();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportList();
                        break;
                    case 'r':
                        if (e.shiftKey) {
                            e.preventDefault();
                            resetTrip();
                        }
                        break;
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner - Smart Packing Lists</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .trip-setup {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .trip-setup h2 {
            color: #495057;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .weather-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .weather-section h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .weather-day {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .progress-section {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12.5px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .category {
            background: #fff;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .category-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .category-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .category-content {
            padding: 25px;
            display: none;
        }

        .category-content.expanded {
            display: block;
        }

        .category.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.3s ease;
        }

        .item:hover {
            background: #f8f9fa;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item.completed {
            background: #d4edda;
            opacity: 0.8;
        }

        .item-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .item-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 500;
            color: #495057;
        }

        .item.completed .item-name {
            text-decoration: line-through;
            color: #6c757d;
        }

        .item-quantity {
            background: #e7f3ff;
            color: #0066cc;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .item-notes {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.9em;
            resize: vertical;
        }

        .control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .floating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .add-item-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #dee2e6;
        }

        .add-item-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #28a745;
        }

        .notification.info {
            background: #17a2b8;
        }

        .notification.warning {
            background: #ffc107;
            color: #333;
        }

        .notification.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .weather-grid {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                bottom: 10px;
                right: 10px;
            }
            
            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß≥ Smart Trip Planner</h1>
            <p>Never forget anything important again - AI-powered packing lists</p>
        </div>

        <div class="main-content">
            <!-- Trip Setup Section -->
            <div class="trip-setup" id="tripSetup">
                <h2>üó∫Ô∏è Plan Your Trip</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="location">üìç Destination</label>
                        <input type="text" id="location" placeholder="e.g., Athens, Greece">
                    </div>
                    <div class="form-group">
                        <label for="nights">üåô Number of Nights</label>
                        <input type="number" id="nights" min="1" max="365" value="5">
                    </div>
                    <div class="form-group">
                        <label for="tripType">üéØ Trip Type</label>
                        <select id="tripType">
                            <option value="business">Business</option>
                            <option value="leisure">Leisure</option>
                            <option value="camping">Camping</option>
                            <option value="winter-sports">Winter Sports</option>
                            <option value="beach">Beach</option>
                            <option value="city-break">City Break</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">üìÖ Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="notes">üìù Special Notes</label>
                        <textarea id="notes" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateTripList()">üöÄ Generate Packing List</button>
                    <button class="btn btn-secondary" onclick="loadSavedTrip()">üìÇ Load Saved Trip</button>
                    <button class="btn btn-danger" onclick="resetTrip()">üîÑ Reset Everything</button>
                </div>
            </div>

            <!-- Weather Section -->
            <div class="weather-section hidden" id="weatherSection">
                <h3>üå§Ô∏è Weather Forecast</h3>
                <div class="weather-grid" id="weatherGrid">
                    <!-- Weather data will be populated here -->
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section hidden" id="progressSection">
                <h3>üìä Packing Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div id="progressStats">
                    <p><strong>0</strong> of <strong>0</strong> items packed</p>
                </div>
            </div>

            <!-- Checklist Section -->
            <div id="checklistContainer" class="hidden">
                <!-- Categories will be populated here -->
            </div>
        </div>
    </div>

    <!-- Floating Control Panel -->
    <div class="control-panel">
        <button class="floating-btn btn-success" onclick="exportList()" title="Export List">üì§</button>
        <button class="floating-btn btn-primary" onclick="saveTrip()" title="Save Trip">üíæ</button>
        <button class="floating-btn" style="background: #6f42c1;" onclick="scrollToTop()" title="Back to Top">‚¨ÜÔ∏è</button>
    </div>

    <script>
        // Global state management
        let currentTrip = {
            location: '',
            nights: 5,
            tripType: 'business',
            startDate: '',
            notes: '',
            items: {},
            completedItems: [],
            customItems: {},
            weather: null
        };

        // Storage key for persistence
        const STORAGE_KEY = 'smart-trip-planner';

        // Item database with smart calculations
        const itemDatabase = {
            clothes: {
                icon: 'üëî',
                items: {
                    'Underwear': { multiplier: 1, essential: true },
                    'Socks (thick)': { multiplier: 1, essential: true },
                    'Socks (thin/ankle)': { multiplier: 1, essential: true },
                    'Sleep bottoms': { multiplier: 1, essential: true },
                    'Sleep tops': { multiplier: 1, essential: true },
                    'T-shirts': { multiplier: 1, essential: true },
                    'Shirts': { multiplier: 0.5, essential: false },
                    'Jeans/Trousers': { multiplier: 0.5, essential: true },
                    'Comfortable bottoms': { multiplier: 0.3, essential: false },
                    'Shoes': { multiplier: 0.3, essential: true }
                }
            },
            toiletries: {
                icon: 'üß¥',
                items: {
                    'Prescription medication': { multiplier: 0, essential: true },
                    'Shavers': { multiplier: 0, essential: true },
                    'Toothbrush & toothpaste': { multiplier: 0, essential: true },
                    'Shower gel/soap': { multiplier: 0, essential: true },
                    'Shampoo': { multiplier: 0, essential: true },
                    'Deodorant': { multiplier: 0, essential: true },
                    'Shower cloth': { multiplier: 0, essential: false },
                    'Wet wipes': { multiplier: 0, essential: false },
                    'Snore spray': { multiplier: 0, essential: false },
                    'Aftershave/perfume': { multiplier: 0, essential: false }
                }
            },
            electronics: {
                icon: 'üíª',
                items: {
                    'Phone charger': { multiplier: 0, essential: true },
                    'Laptop & charger': { multiplier: 0, essential: false },
                    'Spare cables': { multiplier: 0, essential: false },
                    'Power bank': { multiplier: 0, essential: true },
                    'Headphones': { multiplier: 0, essential: true },
                    'Camera': { multiplier: 0, essential: false },
                    'Adapters/converters': { multiplier: 0, essential: true },
                    'Tablet & charger': { multiplier: 0, essential: false }
                }
            },
            documents: {
                icon: 'üìÑ',
                items: {
                    'Passport': { multiplier: 0, essential: true },
                    'Travel insurance': { multiplier: 0, essential: true },
                    'Flight tickets': { multiplier: 0, essential: true },
                    'Hotel confirmations': { multiplier: 0, essential: true },
                    'Driver\'s license': { multiplier: 0, essential: false },
                    'Credit cards': { multiplier: 0, essential: true },
                    'Cash (local currency)': { multiplier: 0, essential: true },
                    'Emergency contacts': { multiplier: 0, essential: true }
                }
            },
            weather_gear: {
                icon: '‚òî',
                items: {
                    'Hoodie/sweatshirt': { multiplier: 0, essential: false },
                    'Waterproof jacket': { multiplier: 0, essential: false },
                    'Waterproof hat': { multiplier: 0, essential: false },
                    'Warm top': { multiplier: 0, essential: false },
                    'Warm pants': { multiplier: 0, essential: false },
                    'Gloves': { multiplier: 0, essential: false },
                    'Winter hat': { multiplier: 0, essential: false },
                    'Scarf': { multiplier: 0, essential: false },
                    'Sunglasses': { multiplier: 0, essential: false },
                    'Sun hat': { multiplier: 0, essential: false }
                }
            }
        };

        // Trip type specific additions
        const tripTypeItems = {
            business: {
                'Business cards': { multiplier: 0, essential: true },
                'Presentation materials': { multiplier: 0, essential: false },
                'Formal shoes': { multiplier: 0, essential: true },
                'Business attire': { multiplier: 0.5, essential: true },
                'Notebook & pens': { multiplier: 0, essential: true }
            },
            leisure: {
                'Comfortable walking shoes': { multiplier: 0, essential: true },
                'Guidebook': { multiplier: 0, essential: false },
                'Entertainment (books/games)': { multiplier: 0, essential: false }
            },
            camping: {
                'Sleeping bag': { multiplier: 0, essential: true },
                'Tent': { multiplier: 0, essential: true },
                'Camping stove': { multiplier: 0, essential: true },
                'Flashlight': { multiplier: 0, essential: true },
                'First aid kit': { multiplier: 0, essential: true }
            },
            beach: {
                'Swimwear': { multiplier: 0.3, essential: true },
                'Beach towel': { multiplier: 0, essential: true },
                'Sunscreen': { multiplier: 0, essential: true },
                'Flip flops': { multiplier: 0, essential: true }
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            setDefaultDate();
        });

        function setDefaultDate() {
            const today = new Date();
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
        }

        function generateTripList() {
            // Get form values
            currentTrip.location = document.getElementById('location').value.trim();
            currentTrip.nights = parseInt(document.getElementById('nights').value);
            currentTrip.tripType = document.getElementById('tripType').value;
            currentTrip.startDate = document.getElementById('startDate').value;
            currentTrip.notes = document.getElementById('notes').value.trim();

            if (!currentTrip.location || !currentTrip.nights) {
                showNotification('Please enter destination and number of nights', 'warning');
                return;
            }

            // Generate items based on trip parameters
            generateItems();
            
            // Fetch weather (simulate for now)
            fetchWeatherData();
            
            // Show sections
            document.getElementById('weatherSection').classList.remove('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('checklistContainer').classList.remove('hidden');
            
            // Render checklist
            renderChecklist();
            updateProgress();
            
            // Save to storage
            saveToStorage();
            
            showNotification('Packing list generated successfully!', 'success');
        }

        function generateItems() {
            currentTrip.items = {};
            
            // Add base items with quantities
            for (const [categoryKey, category] of Object.entries(itemDatabase)) {
                currentTrip.items[categoryKey] = {};
                
                for (const [itemName, itemData] of Object.entries(category.items)) {
                    let quantity = 1;
                    if (itemData.multiplier > 0) {
                        quantity = Math.ceil(currentTrip.nights * itemData.multiplier);
                    }
                    
                    currentTrip.items[categoryKey][itemName] = {
                        quantity: quantity,
                        essential: itemData.essential,
                        completed: false,
                        notes: ''
                    };
                }
            }
            
            // Add trip-type specific items
            if (tripTypeItems[currentTrip.tripType]) {
                if (!currentTrip.items['trip_specific']) {
                    currentTrip.items['trip_specific'] = {};
                }
                
                for (const [itemName, itemData] of Object.entries(tripTypeItems[currentTrip.tripType])) {
                    let quantity = 1;
                    if (itemData.multiplier > 0) {
                        quantity = Math.ceil(currentTrip.nights * itemData.multiplier);
                    }
                    
                    currentTrip.items['trip_specific'][itemName] = {
                        quantity: quantity,
                        essential: itemData.essential,
                        completed: false,
                        notes: ''
                    };
                }
            }
        }

        function fetchWeatherData() {
            // Simulate weather data (replace with real API call)
            const weatherTypes = ['Sunny', 'Partly Cloudy', 'Rainy', 'Cloudy'];
            const temperatures = [15, 18, 22, 25, 28];
            
            currentTrip.weather = [];
            const startDate = new Date(currentTrip.startDate);
            
            for (let i = 0; i < Math.min(currentTrip.nights, 5); i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                
                currentTrip.weather.push({
                    date: date.toLocaleDateString(),
                    condition: weatherTypes[Math.floor(Math.random() * weatherTypes.length)],
                    temp: temperatures[Math.floor(Math.random() * temperatures.length)],
                    icon: 'üå§Ô∏è'
                });
            }
            
            renderWeather();
        }

        function renderWeather() {
            const weatherGrid = document.getElementById('weatherGrid');
            weatherGrid.innerHTML = '';
            
            if (currentTrip.weather) {
                currentTrip.weather.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'weather-day';
                    dayElement.innerHTML = `
                        <div style="font-size: 2em; margin-bottom: 10px;">${day.icon}</div>
                        <div style="font-weight: 600;">${day.date}</div>
                        <div>${day.condition}</div>
                        <div style="font-size: 1.2em; margin-top: 5px;">${day.temp}¬∞C</div>
                    `;
                    weatherGrid.appendChild(dayElement);
                });
            }
        }

        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            container.innerHTML = '';
            
            const categoryNames = {
                clothes: 'Clothes',
                toiletries: 'Toiletries', 
                electronics: 'Electronics',
                documents: 'Documents',
                weather_gear: 'Weather Gear',
                trip_specific: getTypeName(currentTrip.tripType)
            };
            
            for (const [categoryKey, items] of Object.entries(currentTrip.items)) {
                if (Object.keys(items).length === 0) continue;
                
                const category = createCategoryElement(
                    categoryKey,
                    categoryNames[categoryKey] || categoryKey,
                    itemDatabase[categoryKey]?.icon || 'üì¶',
                    items
                );
                container.appendChild(category);
            }
        }

        function createCategoryElement(categoryKey, categoryName, icon, items) {
            const totalItems = Object.keys(items).length;
            const completedItems = Object.values(items).filter(item => item.completed).length;
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            categoryDiv.innerHTML = `
                <div class="category-header" onclick="toggleCategory('${categoryKey}')">
                    <div class="category-title">
                        <span>${icon}</span>
                        <span>${categoryName}</span>
                    </div>
                    <div class="category-progress">
                        <div class="category-badge">${completedItems}/${totalItems}</div>
                        <div class="category-badge">${percentage}%</div>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                </div>
                <div class="category-content" id="category-${categoryKey}">
                    ${Object.entries(items).map(([itemName, itemData]) => 
                        createItemElement(categoryKey, itemName, itemData)
                    ).join('')}
                    <div class="add-item-section">
                        <div class="add-item-form">
                            <input type="text" placeholder="Add custom item..." id="new-item-${categoryKey}">
                            <input type="number" placeholder="Qty" min="1" value="1" id="new-qty-${categoryKey}">
                            <button class="btn btn-primary" onclick="addCustomItem('${categoryKey}')">Add</button>
                        </div>
                    </div>
                </div>
            `;
            
            return categoryDiv;
        }

        function createItemElement(categoryKey, itemName, itemData) {
            const itemId = `${categoryKey}-${itemName.replace(/[^a-zA-Z0-9]/g, '')}`;
            return `
                <div class="item ${itemData.completed ? 'completed' : ''}" id="item-${itemId}">
                    <input type="checkbox" class="item-checkbox" 
                           ${itemData.completed ? 'checked' : ''} 
                           onchange="toggleItem('${categoryKey}', '${itemName}')">
                    <div class="item-content">
                        <div class="item-name">
                            ${itemName}
                            ${itemData.essential ? '<span style="color: #dc3545;">*</span>' : ''}
                        </div>
                        ${itemData.quantity > 1 ? `<div class="item-quantity">√ó${itemData.quantity}</div>` : ''}
                    </div>
                    <div style="width: 100%;">
                        <textarea class="item-notes" placeholder="Add notes..." 
                                  onchange="updateItemNotes('${categoryKey}', '${itemName}', this.value)">${itemData.notes || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function getTypeName(tripType) {
            const names = {
                business: 'Business Items',
                leisure: 'Leisure Items',
                camping: 'Camping Gear',
                beach: 'Beach Items',
                'winter-sports': 'Winter Sports Gear',
                'city-break': 'City Break Items'
            };
            return names[tripType] || 'Trip Specific';
        }

        function toggleCategory(categoryKey) {
            const content = document.getElementById(`category-${categoryKey}`);
            const category = content.parentElement;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                category.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                category.classList.add('expanded');
            }
        }

        function toggleItem(categoryKey, itemName) {
            currentTrip.items[categoryKey][itemName].completed = !currentTrip.items[categoryKey][itemName].completed;
            
            const itemId = `${categoryKey}-${itemName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const itemElement = document.getElementById(`item-${itemId}`);
            
            if (currentTrip.items[categoryKey][itemName].completed) {
                itemElement.classList.add('completed');
                showNotification(`‚úÖ ${itemName} packed!`, 'success');
            } else {
                itemElement.classList.remove('completed');
                showNotification(`üì¶ ${itemName} unpacked`, 'info');
            }
            
            updateProgress();
            saveToStorage();
            updateCategoryProgress(categoryKey);
        }

        function updateItemNotes(categoryKey, itemName, notes) {
            currentTrip.items[categoryKey][itemName].notes = notes;
            saveToStorage();
        }

        function addCustomItem(categoryKey) {
            const nameInput = document.getElementById(`new-item-${categoryKey}`);
            const qtyInput = document.getElementById(`new-qty-${categoryKey}`);
            
            const itemName = nameInput.value.trim();
            const quantity = parseInt(qtyInput.value) || 1;
            
            if (!itemName) {
                showNotification('Please enter an item name', 'warning');
                return;
            }
            
            if (currentTrip.items[categoryKey][itemName]) {
                showNotification('Item already exists in this category', 'warning');
                return;
            }
            
            currentTrip.items[categoryKey][itemName] = {
                quantity: quantity,
                essential: false,
                completed: false,
                notes: '',
                custom: true
            };
            
            // Clear inputs
            nameInput.value = '';
            qtyInput.value = '1';
            
            // Re-render the category
            renderChecklist();
            updateProgress();
            saveToStorage();
            
            showNotification(`Added "${itemName}" to ${categoryKey}`, 'success');
        }

        function updateProgress() {
            let totalItems = 0;
            let completedItems = 0;
            
            for (const [categoryKey, items] of Object.entries(currentTrip.items)) {
                for (const [itemName, itemData] of Object.entries(items)) {
                    totalItems++;
                    if (itemData.completed) {
                        completedItems++;
                    }
                }
            }
            
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            const progressFill = document.getElementById('progressFill');
            const progressStats = document.getElementById('progressStats');
            
            progressFill.style.width = `${percentage}%`;
            progressFill.textContent = `${percentage}%`;
            
            progressStats.innerHTML = `
                <p><strong>${completedItems}</strong> of <strong>${totalItems}</strong> items packed</p>
                ${percentage === 100 ? '<p style="color: #28a745; font-weight: 600;">üéâ All packed! Ready to go!</p>' : ''}
            `;
        }

        function updateCategoryProgress(categoryKey) {
            const items = currentTrip.items[categoryKey];
            const totalItems = Object.keys(items).length;
            const completedItems = Object.values(items).filter(item => item.completed).length;
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            // Update category header badges
            const categoryElement = document.querySelector(`[onclick="toggleCategory('${categoryKey}')"]`);
            if (categoryElement) {
                const badges = categoryElement.querySelectorAll('.category-badge');
                if (badges.length >= 2) {
                    badges[0].textContent = `${completedItems}/${totalItems}`;
                    badges[1].textContent = `${percentage}%`;
                }
            }
        }

        function saveTrip() {
            const tripName = prompt('Enter a name for this trip:', `${currentTrip.location} - ${currentTrip.tripType}`);
            if (!tripName) return;
            
            const savedTrips = JSON.parse(localStorage.getItem('saved-trips') || '{}');
            savedTrips[tripName] = { ...currentTrip };
            localStorage.setItem('saved-trips', JSON.stringify(savedTrips));
            
            showNotification(`Trip "${tripName}" saved!`, 'success');
        }

        function loadSavedTrip() {
            const savedTrips = JSON.parse(localStorage.getItem('saved-trips') || '{}');
            const tripNames = Object.keys(savedTrips);
            
            if (tripNames.length === 0) {
                showNotification('No saved trips found', 'info');
                return;
            }
            
            const tripName = prompt(`Choose a trip to load:\n${tripNames.map((name, i) => `${i + 1}. ${name}`).join('\n')}\n\nEnter trip name:`);
            
            if (tripName && savedTrips[tripName]) {
                currentTrip = { ...savedTrips[tripName] };
                
                // Update form fields
                document.getElementById('location').value = currentTrip.location;
                document.getElementById('nights').value = currentTrip.nights;
                document.getElementById('tripType').value = currentTrip.tripType;
                document.getElementById('startDate').value = currentTrip.startDate;
                document.getElementById('notes').value = currentTrip.notes;
                
                // Show sections
                document.getElementById('weatherSection').classList.remove('hidden');
                document.getElementById('progressSection').classList.remove('hidden');
                document.getElementById('checklistContainer').classList.remove('hidden');
                
                // Render everything
                renderWeather();
                renderChecklist();
                updateProgress();
                
                saveToStorage();
                showNotification(`Loaded trip "${tripName}"`, 'success');
            } else if (tripName) {
                showNotification('Trip not found', 'error');
            }
        }

        function exportList() {
            let exportText = `üß≥ PACKING LIST - ${currentTrip.location}\n`;
            exportText += `üìÖ ${currentTrip.startDate} | ${currentTrip.nights} nights | ${currentTrip.tripType}\n\n`;
            
            if (currentTrip.notes) {
                exportText += `üìù Notes: ${currentTrip.notes}\n\n`;
            }
            
            // Weather section
            if (currentTrip.weather) {
                exportText += `üå§Ô∏è WEATHER FORECAST:\n`;
                currentTrip.weather.forEach(day => {
                    exportText += `‚Ä¢ ${day.date}: ${day.condition}, ${day.temp}¬∞C\n`;
                });
                exportText += `\n`;
            }
            
            // Progress
            let totalItems = 0;
            let completedItems = 0;
            for (const items of Object.values(currentTrip.items)) {
                totalItems += Object.keys(items).length;
                completedItems += Object.values(items).filter(item => item.completed).length;
            }
            
            exportText += `üìä PROGRESS: ${completedItems}/${totalItems} items (${Math.round((completedItems/totalItems)*100)}%)\n\n`;
            
            // Categories
            const categoryNames = {
                clothes: 'üëî CLOTHES',
                toiletries: 'üß¥ TOILETRIES',
                electronics: 'üíª ELECTRONICS',
                documents: 'üìÑ DOCUMENTS',
                weather_gear: '‚òî WEATHER GEAR',
                trip_specific: `üéØ ${getTypeName(currentTrip.tripType).toUpperCase()}`
            };
            
            for (const [categoryKey, items] of Object.entries(currentTrip.items)) {
                if (Object.keys(items).length === 0) continue;
                
                exportText += `${categoryNames[categoryKey] || categoryKey.toUpperCase()}:\n`;
                
                for (const [itemName, itemData] of Object.entries(items)) {
                    const checkbox = itemData.completed ? '‚òë' : '‚òê';
                    const quantity = itemData.quantity > 1 ? ` (√ó${itemData.quantity})` : '';
                    const essential = itemData.essential ? ' *' : '';
                    const notes = itemData.notes ? ` - ${itemData.notes}` : '';
                    
                    exportText += `${checkbox} ${itemName}${quantity}${essential}${notes}\n`;
                }
                exportText += `\n`;
            }
            
            exportText += `\n* = Essential items\n`;
            exportText += `Generated by Smart Trip Planner - ${new Date().toLocaleString()}`;
            
            // Create download
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `packing-list-${currentTrip.location.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Packing list exported!', 'success');
        }

        function resetTrip() {
            if (confirm('Are you sure you want to reset everything? This will clear your current trip and all progress.')) {
                currentTrip = {
                    location: '',
                    nights: 5,
                    tripType: 'business',
                    startDate: '',
                    notes: '',
                    items: {},
                    completedItems: [],
                    customItems: {},
                    weather: null
                };
                
                // Clear form
                document.getElementById('location').value = '';
                document.getElementById('nights').value = '5';
                document.getElementById('tripType').value = 'business';
                document.getElementById('startDate').value = '';
                document.getElementById('notes').value = '';
                
                // Hide sections
                document.getElementById('weatherSection').classList.add('hidden');
                document.getElementById('progressSection').classList.add('hidden');
                document.getElementById('checklistContainer').classList.add('hidden');
                
                // Clear storage
                localStorage.removeItem(STORAGE_KEY);
                
                showNotification('Trip reset successfully!', 'info');
                setDefaultDate();
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentTrip));
            } catch (error) {
                console.error('Failed to save to storage:', error);
                showNotification('Failed to save progress', 'error');
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const savedTrip = JSON.parse(saved);
                    
                    // Merge with current trip to handle any new structure
                    currentTrip = { ...currentTrip, ...savedTrip };
                    
                    // Update form if we have saved data
                    if (currentTrip.location) {
                        document.getElementById('location').value = currentTrip.location;
                        document.getElementById('nights').value = currentTrip.nights;
                        document.getElementById('tripType').value = currentTrip.tripType;
                        document.getElementById('startDate').value = currentTrip.startDate;
                        document.getElementById('notes').value = currentTrip.notes;
                        
                        // Show sections if we have items
                        if (Object.keys(currentTrip.items).length > 0) {
                            document.getElementById('weatherSection').classList.remove('hidden');
                            document.getElementById('progressSection').classList.remove('hidden');
                            document.getElementById('checklistContainer').classList.remove('hidden');
                            
                            renderWeather();
                            renderChecklist();
                            updateProgress();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load from storage:', error);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Auto-save functionality
        setInterval(() => {
            if (Object.keys(currentTrip.items).length > 0) {
                saveToStorage();
            }
        }, 30000); // Auto-save every 30 seconds

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            saveToStorage();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveTrip();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportList();
                        break;
                    case 'r':
                        if (e.shiftKey) {
                            e.preventDefault();
                            resetTrip();
                        }
                        break;
                }
            }
        });

        // Add some sample weather API integration (you can replace with real API)
        function fetchRealWeather(location, startDate, days) {
            // This is where you'd integrate with a weather API like OpenWeatherMap
            // For now, we're using simulated data
            
            // Example with OpenWeatherMap API (uncomment and add your API key):
            /*
            const API_KEY = 'your-openweathermap-api-key';
            const url = `https://api.openweathermap.org/data/2.5/forecast?q=${location}&appid=${API_KEY}&units=metric`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Process the weather data
                    currentTrip.weather = processWeatherData(data, days);
                    renderWeather();
                })
                .catch(error => {
                    console.error('Weather fetch failed:', error);
                    // Fall back to simulated data
                    fetchWeatherData();
                });
            */
        }

        // Add seasonal recommendations
        function addSeasonalItems() {
            const startDate = new Date(currentTrip.startDate);
            const month = startDate.getMonth(); // 0-11
            
            // Winter months (Dec, Jan, Feb)
            if (month === 11 || month === 0 || month === 1) {
                addWeatherItems(['heavy-coat', 'thermal-underwear', 'winter-boots', 'hand-warmers']);
            }
            // Summer months (Jun, Jul, Aug)
            else if (month >= 5 && month <= 7) {
                addWeatherItems(['sunscreen', 'sun-hat', 'light-clothes', 'sandals']);
            }
            // Spring/Fall
            else {
                addWeatherItems(['light-jacket', 'umbrella', 'layering-clothes']);
            }
        }

        function addWeatherItems(items) {
            if (!currentTrip.items.weather_gear) {
                currentTrip.items.weather_gear = {};
            }
            
            items.forEach(item => {
                if (!currentTrip.items.weather_gear[item]) {
                    currentTrip.items.weather_gear[item] = {
                        quantity: 1,
                        essential: false,
                        completed: false,
                        notes: 'Added based on season',
                        seasonal: true
                    };
                }
            });
        }

        // Analytics for trip insights
        function getTripInsights() {
            const insights = {
                totalItems: 0,
                essentialItems: 0,
                completedItems: 0,
                customItems: 0,
                categories: Object.keys(currentTrip.items).length
            };
            
            for (const items of Object.values(currentTrip.items)) {
                for (const itemData of Object.values(items)) {
                    insights.totalItems++;
                    if (itemData.essential) insights.essentialItems++;
                    if (itemData.completed) insights.completedItems++;
                    if (itemData.custom) insights.customItems++;
                }
            }
            
            return insights;
        }

        // PWA support (if you want to make it installable)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>
